name: {{ cookiecutter.project_name }}app

services:
  dev:
    container_name: dev-{{ cookiecutter.project_name }}
    image: {{ cookiecutter.project_name }}:dev
    build:
      context: .
      dockerfile: dockerfiles/train.dockerfile
      target: dev
    networks:
      - {{ cookiecutter.project_name }}-network # <-- Use the unique network
    volumes:
      - ..:/code:rw  # Mount the entire repo as read/write in the container
      # Uncomment if you need to store the data/models elsewhere
      # - ../data/raw:/data/raw:ro
      # - ../data/processed:/data/processed:rw
      # - ../models:/models:rw
    # Keep the container running for development
    tty: true
    stdin_open: true
    command: tail -f /dev/null
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
  
  trainer: 
    container_name: trainer-{{ cookiecutter.project_name }}
    image: {{ cookiecutter.project_name }}:trainer
    build:
      context: ..
      dockerfile: dockerfiles/Dockerfile
      target: "trainer"
    networks:
      - {{ cookiecutter.project_name }}-network # <-- Use the unique network
    volumes:
      - ../data/raw:/data/raw:ro
      - ../data/processed:/data/processed:rw
      - ../models:/models:rw
    command: "python -u src/{{ cookiecutter.project_name }}/train.py"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

# Define the network as external (or just defined)
networks:
  {{ cookiecutter.project_name }}-network:
    name: {{ cookiecutter.project_name }}-network # <-- Explicitly name the network to ensure uniqueness
    # driver: bridge # (Optional: default)